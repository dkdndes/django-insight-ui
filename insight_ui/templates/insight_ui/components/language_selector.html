{% load i18n %}

<div class="insight-language-selector insight-language-selector--{{ theme }}" {% if options.id %}id="{{ options.id }}"{% endif %}>
  <label for="language-select" class="insight-language-selector__label">
    {% trans 'Sprache ausw채hlen' %}
  </label>
  <select 
    id="language-select" 
    name="language" 
    class="insight-language-selector__select"
    onchange="changeLanguage(this.value)"
    aria-label="{% trans 'Sprache 채ndern' %}">
    {% for language in available_languages %}
      <option 
        value="{{ language.code }}"
        {% if current_language == language.code %}selected{% endif %}>
        {{ language.native }} ({{ language.name }})
      </option>
    {% endfor %}
  </select>
  
  <script>
    function changeLanguage(languageCode) {
      // Erstelle ein verstecktes Formular f체r den Sprachwechsel
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/i18n/setlang/';
      
      // CSRF-Token hinzuf체gen
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') || 
                       document.querySelector('meta[name=csrf-token]');
      if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.content || csrfToken.value;
        form.appendChild(csrfInput);
      } else {
        // Fallback: CSRF-Token aus Cookie lesen
        const csrfCookie = document.cookie.split(';').find(cookie => 
          cookie.trim().startsWith('csrftoken=')
        );
        if (csrfCookie) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfCookie.split('=')[1];
          form.appendChild(csrfInput);
        }
      }
      
      const languageInput = document.createElement('input');
      languageInput.type = 'hidden';
      languageInput.name = 'language';
      languageInput.value = languageCode;
      form.appendChild(languageInput);
      
      const nextInput = document.createElement('input');
      nextInput.type = 'hidden';
      nextInput.name = 'next';
      nextInput.value = window.location.pathname + window.location.search;
      form.appendChild(nextInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  </script>
</div>
