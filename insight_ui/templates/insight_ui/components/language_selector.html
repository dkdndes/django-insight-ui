{% load i18n %}
{% get_available_languages as LANGUAGES %}
{% get_current_language as LANGUAGE_CODE %}

<div class="insight-language-selector relative">
  <label for="language-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
    {% trans 'Sprache auswählen' %}
  </label>
  <select 
    id="language-select" 
    name="language" 
    class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    onchange="changeLanguage(this.value)"
    aria-label="{% trans 'Sprache ändern' %}">
    {% for code, name in LANGUAGES %}
      <option 
        value="{{ code }}"
        {% if LANGUAGE_CODE == code %}selected{% endif %}>
        {{ name }}
      </option>
    {% endfor %}
  </select>
  
  <script>
    // Globale Funktion für Sprachwechsel (falls noch nicht definiert)
    if (typeof window.changeLanguage === 'undefined') {
      window.changeLanguage = function(languageCode) {
        console.log('Sprachwechsel zu:', languageCode);
        
        // Erstelle ein verstecktes Formular für den Sprachwechsel
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/i18n/setlang/';
        form.style.display = 'none';
        
        // CSRF-Token aus dem DOM holen
        let csrfToken = null;
        
        // Versuche CSRF-Token aus verschiedenen Quellen zu holen
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        
        if (csrfInput) {
          csrfToken = csrfInput.value;
          console.log('CSRF-Token aus Input gefunden');
        } else {
          // Fallback: CSRF-Token aus Cookie lesen
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith('csrftoken=')) {
              csrfToken = trimmed.substring('csrftoken='.length);
              console.log('CSRF-Token aus Cookie gefunden');
              break;
            }
          }
        }
        
        if (!csrfToken) {
          console.error('Kein CSRF-Token gefunden! Sprachwechsel wird möglicherweise fehlschlagen.');
          alert('Fehler: CSRF-Token nicht gefunden. Bitte laden Sie die Seite neu.');
          return;
        }
        
        // CSRF-Token hinzufügen
        const csrfHiddenInput = document.createElement('input');
        csrfHiddenInput.type = 'hidden';
        csrfHiddenInput.name = 'csrfmiddlewaretoken';
        csrfHiddenInput.value = csrfToken;
        form.appendChild(csrfHiddenInput);
        
        // Sprache hinzufügen
        const languageInput = document.createElement('input');
        languageInput.type = 'hidden';
        languageInput.name = 'language';
        languageInput.value = languageCode;
        form.appendChild(languageInput);
        
        // Redirect-URL hinzufügen
        const nextInput = document.createElement('input');
        nextInput.type = 'hidden';
        nextInput.name = 'next';
        nextInput.value = window.location.pathname + window.location.search;
        form.appendChild(nextInput);
        
        // Formular zum DOM hinzufügen und absenden
        document.body.appendChild(form);
        console.log('Formular wird abgesendet...');
        form.submit();
      };
    }
    
    // Stelle sicher, dass die Funktion auch nach dem Laden verfügbar ist
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Language selector JavaScript geladen');
    });
  </script>
</div>
