{% load i18n %}
{% get_available_languages as LANGUAGES %}
{% get_current_language as LANGUAGE_CODE %}

<div class="insight-language-selector relative">
  <label for="language-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
    {% trans 'Sprache auswählen' %}
  </label>
  <form id="navbar-language-form" method="post" action="{% url 'change_language' %}" hx-post="{% url 'change_language' %}" hx-target="body" hx-swap="none">
    {% csrf_token %}
    <input name="next" type="hidden" value="{{ request.get_full_path }}" />
    <input name="language" type="hidden" />
    <select 
      id="language-select" 
      name="language_select" 
      class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      onchange="this.form.elements['language'].value=this.value; this.form.submit();"
      aria-label="{% trans 'Sprache ändern' %}">
      {% get_available_languages as LANGUAGES %}
      {% get_current_language as LANGUAGE_CODE %}
      {% for code, name in LANGUAGES %}
        <option value="{{ code }}" {% if LANGUAGE_CODE == code %}selected{% endif %}>
          {{ name }}
        </option>
      {% endfor %}
    </select>
  </form>
  
  <script>
    // Globale Funktion für Sprachwechsel (falls noch nicht definiert)
    if (typeof window.changeLanguage === 'undefined') {
      window.changeLanguage = function(languageCode) {
        console.log('Sprachwechsel zu:', languageCode);
        
        // Django CSRF-Token holen - verbesserte Methode
        function getCSRFToken() {
          // 1. Versuche Meta-Tag
          const csrfMeta = document.querySelector('meta[name="csrf-token"]');
          if (csrfMeta) {
            const content = csrfMeta.getAttribute('content');
            // Entferne HTML-Tags falls vorhanden
            const cleanToken = content.replace(/<[^>]*>/g, '').trim();
            if (cleanToken && cleanToken.length > 10) {
              return cleanToken;
            }
          }
          
          // 2. Fallback: CSRF-Token aus verstecktem Input
          const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
          if (csrfInput && csrfInput.value) {
            return csrfInput.value;
          }
          
          // 3. Fallback: CSRF-Token aus Cookie (Django Standard)
          function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          }
          
          return getCookie('csrftoken');
        }
        
        const csrfToken = getCSRFToken();
        console.log('CSRF-Token gefunden:', csrfToken ? 'Ja' : 'Nein');
        
        if (!csrfToken) {
          console.error('Kein CSRF-Token gefunden!');
          // Versuche es trotzdem - Django könnte CSRF für diese View deaktiviert haben
          console.warn('Versuche Sprachwechsel ohne CSRF-Token...');
        }
        
        // Erstelle ein verstecktes Formular für den Sprachwechsel
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/i18n/setlang/';
        form.style.display = 'none';
        
        // CSRF-Token hinzufügen (falls vorhanden)
        if (csrfToken) {
          const csrfHiddenInput = document.createElement('input');
          csrfHiddenInput.type = 'hidden';
          csrfHiddenInput.name = 'csrfmiddlewaretoken';
          csrfHiddenInput.value = csrfToken;
          form.appendChild(csrfHiddenInput);
        }
        
        // Sprache hinzufügen
        const languageInput = document.createElement('input');
        languageInput.type = 'hidden';
        languageInput.name = 'language';
        languageInput.value = languageCode;
        form.appendChild(languageInput);
        
        // Redirect-URL hinzufügen
        const nextInput = document.createElement('input');
        nextInput.type = 'hidden';
        nextInput.name = 'next';
        nextInput.value = window.location.pathname + window.location.search;
        form.appendChild(nextInput);
        
        // Formular zum DOM hinzufügen und absenden
        document.body.appendChild(form);
        console.log('Formular wird abgesendet...');
        form.submit();
      };
    }
    
    // Stelle sicher, dass die Funktion auch nach dem Laden verfügbar ist
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Language selector JavaScript geladen');
      
      // Debug: Zeige verfügbare CSRF-Token-Quellen
      const csrfMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
      const csrfCookie = document.cookie.includes('csrftoken=');
      
      console.log('CSRF-Quellen verfügbar:', {
        metaTag: !!csrfMeta,
        metaContent: csrfMeta ? csrfMeta.getAttribute('content') : 'nicht gefunden',
        hiddenInput: !!csrfInput,
        inputValue: csrfInput ? csrfInput.value : 'nicht gefunden',
        cookie: csrfCookie
      });
    });
  </script>
</div>
